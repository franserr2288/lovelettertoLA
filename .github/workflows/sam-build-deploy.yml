name: SAM Validate, Build, Test, Deploy
on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  id-token: write   # This is required for requesting the JWT
  contents: read 

jobs:
  discover:
    runs-on: ubuntu-latest
    outputs:
      templates: ${{ steps.find-templates.outputs.templates }}
    steps:
      - uses: actions/checkout@v3
      - id: find-templates
        run: |
          # Find all template.yaml files and extract their directories
          TEMPLATES=$(find . -name 'template.yaml' -o -name 'template.yml' | \
            jq -R -s -c 'split("\n")[:-1] | map(select(length > 0))')
          echo "templates=$TEMPLATES" >> $GITHUB_OUTPUT
  deploy:
    needs: discover
    strategy:
      matrix:
        # Virginia, Oregon, Frankfurt, London, Singapore, Sydney
        # region: [us-east-1, us-west-2 ,ap-southeast-1, ap-southeast-2, eu-central-1]
        region: [us-east-1]
        template: ${{ fromJson(needs.discover.outputs.templates) }}


    runs-on: ubuntu-latest
    # param it later
    environment: dev

    outputs:
      env-name: ${{ steps.env-name.outputs.environment }}
    steps:
      - uses: actions/checkout@v2

      - name: Install Dependencies with Apt Get
        run: |
          sudo apt-get update
          sudo apt-get install python3.12 jq -y

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        
        with:
          role-to-assume: ${{ secrets.AWS_GITHUB_ACTIONS_ROLE_ARN }}
          aws-region: ${{ matrix.region }}

      - name: Configure variables
        shell: bash
        id: vars
        env:
          REPO: ${{ github.repository }}
          HASH: ${{ github.sha }}
          REF: ${{ github.ref }}
        run: |
          # Set variables
          BRANCH=${REF#refs/heads/}
          REPOSITORY=`echo $REPO | tr "/" "-"`
          ENVIRONMENT=$BRANCH-$REPOSITORY-${{ matrix.region }}
      - uses: aws-actions/setup-sam@v2

      - run: |
          TEMPLATE_DIR=$(dirname ${{ matrix.template }})
          cd $TEMPLATE_DIR
          sam build
          sam deploy --config-file samconfig.toml --no-fail-on-empty-changeset sam deploy --resolve-image-repos