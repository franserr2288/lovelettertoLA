name: SAM Validate, Build, Test, Deploy
on:
  push:
    branches: [ main ]

jobs:
  discover:
    runs-on: ubuntu-latest
    outputs:
      templates: ${{ steps.find-templates.outputs.templates }}
    steps:
      - uses: actions/checkout@v3
      - id: find-templates
        run: |
          # Find all template.yaml files and extract their directories
          TEMPLATES=$(find . -name 'template.yaml' -o -name 'template.yml' | \
            jq -R -s -c 'split("\n")[:-1] | map(select(length > 0))')
          echo "templates=$TEMPLATES" >> $GITHUB_OUTPUT
  deploy:
    needs: discover
    strategy:
      matrix:
        # Virginia, Oregon, Frankfurt, London, Singapore, Sydney
        # region: [us-east-1, us-west-2 ,ap-southeast-1, ap-southeast-2, eu-central-1]
        region: [us-east-1]
        template: ${{ fromJson(needs.discover.outputs.templates) }}


    runs-on: ubuntu-latest
    outputs:
      env-name: ${{ steps.env-name.outputs.environment }}
    steps:
      - uses: actions/checkout@v2

      - name: Install Dependencies with Apt Get
        run: |
          sudo apt-get update
          sudo apt-get install python3.8 jq -y

      - name: Configure AWS credentials
        id: creds
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ matrix.region }}

      - name: Configure variables
        shell: bash
        id: vars
        env:
          REPO: ${{ github.repository }}
          HASH: ${{ github.sha }}
          REF: ${{ github.ref }}
        run: |
          # Set variables
          BRANCH=${REF#refs/heads/}
          REPOSITORY=`echo $REPO | tr "/" "-"`
          ENVIRONMENT=$BRANCH-$REPOSITORY-${{ matrix.region }}
          echo "::set-output name=branch::$BRANCH"
          echo "::set-output name=repository::$REPOSITORY"
          echo "::set-output name=environment::$ENVIRONMENT"
          echo "The region is ${{ matrix.region }}"
          echo "The repository is $REPOSITORY"
          echo "The environment is $ENVIRONMENT"
          echo "The branch is $BRANCH"
      - uses: aws-actions/setup-sam@v2

      - run: |
          TEMPLATE_DIR=$(dirname ${{ matrix.template }})
          cd $TEMPLATE_DIR
          sam build
          sam deploy --config-file samconfig.toml --no-fail-on-empty-changeset